generator dbClient {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum UserRole {
    ADMIN
    LECTURER
    STUDENT
}

enum Gender {
    MALE
    FEMALE
}

enum StudentStatus {
    ACTIVE
    SUSPENDED
    WITHDRAWN
    GRADUATED
    DEFERRED
}

enum Semester {
    HARMATTAN
    RAIN
    ACADEMIC_YEAR
}

enum LecturerRole {
    PROVOST
    DEAN
    HOD
    PART_ADVISER
}

enum FileCategory {
    RESULTS
    LECTURERS
    COURSES
    STUDENTS
    REGISTRATIONS
}

enum EnrollmentStatus {
    PASSED
    FAILED
    ENROLLED
    ABSENT
}

enum Level {
    LVL_100
    LVL_200
    LVL_300
    LVL_400
    LVL_500
    LVL_600
    LVL_700
}

enum ResultType {
    INITIAL
    RESIT
}

enum ApprovalStatus {
    REQUESTED 
    ACCEPTED
    REJECTED
}

model User {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    email    String   @unique
    password String?
    role     UserRole

    admin    Admin?
    lecturer Lecturer?
    student  Student?
    files    File[]

    @@index([role])
    @@index([deletedAt])
    @@map("users")
}

model Admin {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    name  String
    phone String?

    userId String @unique
    user   User   @relation(fields: [userId], references: [id])

    @@index([name])
    @@index([deletedAt])
    @@map("admins")
}

model Lecturer {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    firstName     String
    lastName      String
    otherName     String?
    phone         String? @unique
    gender        Gender
    title         String
    qualification String?

    userId          String                @unique
    user            User                  @relation(fields: [userId], references: [id])
    departmentId    String
    department      Department            @relation(fields: [departmentId], references: [id])
    designations    LecturerDesignation[]
    coursesLectured CourseLecturer[]

    @@index([departmentId])
    @@index([lastName])
    @@index([deletedAt])
    @@map("lecturers")
}

model LecturerDesignation {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())

    entity String
    role   LecturerRole

    lecturerId String
    lecturer   Lecturer @relation(fields: [lecturerId], references: [id])

    requestedApprovals ApprovalRequest[] @relation("approval_lecturer_designation")

    @@unique([entity, role, lecturerId], name: "designation")
    @@index([role])
    @@index([lecturerId])
    @@map("lecturer_designations")
}

model Student {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    matricNumber  String        @unique
    firstName     String
    lastName      String
    otherName     String?
    admissionYear String
    level         Level
    gender        Gender
    degree        String
    status        StudentStatus @default(ACTIVE)

    userId       String     @unique
    user         User       @relation(fields: [userId], references: [id])
    departmentId String
    department   Department @relation(fields: [departmentId], references: [id])

    enrollments Enrollment[]

    @@index([departmentId])
    @@index([level])
    @@index([status])
    @@index([matricNumber])
    @@index([deletedAt])
    @@index([departmentId, level])
    @@index([departmentId, status])
    @@map("students")
}

model Faculty {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    name String @unique

    departments Department[]

    @@index([deletedAt])
    @@map("faculties")
}

model Department {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    name      String @unique
    shortName String @unique
    maxLevel  Level

    facultyId String
    faculty   Faculty @relation(fields: [facultyId], references: [id])

    lecturers            Lecturer[]
    students             Student[]
    courseDeptsAndLevels CourseSesnDeptAndLevel[]
    courses              Course[]

    @@index([facultyId])
    @@index([deletedAt])
    @@index([name])
    @@map("departments")
}

model Session {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    academicYear String   @unique
    startDate    DateTime
    endDate      DateTime

    courseSessions CourseSession[]

    @@index([startDate])
    @@index([endDate])
    @@map("sessions")
}

model Course {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    code        String   @unique
    title       String
    description String
    units       Int
    semester    Semester

    departmentId String
    department   Department @relation(fields: [departmentId], references: [id])

    courseSessions CourseSession[]

    @@index([deletedAt])
    @@index([departmentId])
    @@index([semester])
    @@index([code])
    @@map("courses")
}

// TODO: Pre-requisites and post-requisites should be stored for courses

model CourseSession {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    isApproved  Boolean   @default(false)
    approvedAt  DateTime?
    isPublished Boolean   @default(false)
    publishedAt DateTime?

    courseId        String
    course          Course        @relation(fields: [courseId], references: [id])
    gradingSystemId String
    gradingSystem   GradingSystem @relation(fields: [gradingSystemId], references: [id])
    sessionId       String
    session         Session       @relation(fields: [sessionId], references: [id])

    lecturers      CourseLecturer[]
    enrollments    Enrollment[]
    deptsAndLevels CourseSesnDeptAndLevel[]

    approvalRequests ApprovalFlow[] @relation("approval_flow")

    @@unique([courseId, sessionId], name: "uniqueCourseSession")
    @@index([courseId])
    @@index([sessionId])
    @@index([isApproved])
    @@index([isPublished])
    @@map("course_sessions")
}

model GradingSystem {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    name        String  @unique
    description String?
    threshold   Float

    courseSessions CourseSession[]
    fields         GradingField[]
    ranges         GradingRange[]

    @@index([deletedAt])
    @@index([name])
    @@map("grading_systems")
}

model GradingField {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    label       String
    description String
    variable    String
    maxValue    Float
    weight      Float

    gradingSystemId String
    gradingSystem   GradingSystem @relation(fields: [gradingSystemId], references: [id])

    @@unique([gradingSystemId, label, variable])
    @@index([label])
    @@map("grading_fields")
}

model GradingRange {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    label       String
    description String
    minScore    Float
    maxScore    Float

    gradingSystemId String
    gradingSystem   GradingSystem @relation(fields: [gradingSystemId], references: [id])

    @@unique([gradingSystemId, label])
    @@index([label])
    @@map("grading_ranges")
}

model CourseLecturer {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    isCoordinator Boolean @default(false)

    courseSessionId String
    courseSession   CourseSession @relation(fields: [courseSessionId], references: [id])
    lecturerId      String
    lecturer        Lecturer      @relation(fields: [lecturerId], references: [id])

    @@unique([courseSessionId, lecturerId], name: "uniqueCourseSessionLecturer")
    @@index([courseSessionId])
    @@index([lecturerId])
    @@index([isCoordinator])
    @@map("course_lecturers")
}

model CourseSesnDeptAndLevel {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    level Level

    departmentId    String
    department      Department    @relation(fields: [departmentId], references: [id])
    courseSessionId String
    courseSession   CourseSession @relation(fields: [courseSessionId], references: [id])

    @@unique([courseSessionId, departmentId, level], name: "uniqueCourseSesnDeptAndLevel")
    @@index([courseSessionId])
    @@index([departmentId])
    @@index([level])
    @@map("course_session_department_levels")
}

model Enrollment {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    status            EnrollmentStatus @default(ENROLLED)
    levelAtEnrollment Level

    studentId       String
    student         Student       @relation(fields: [studentId], references: [id])
    courseSessionId String
    courseSession   CourseSession @relation(fields: [courseSessionId], references: [id])

    results Result[]

    @@unique([studentId, courseSessionId], name: "uniqueEnrollment")
    @@index([studentId])
    @@index([courseSessionId])
    @@index([status])
    @@map("enrollments")
}

model Result {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    scores      Json
    evaluations Json?
    type        ResultType

    enrollmentId String
    enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])

    @@unique([enrollmentId, type], name: "uniqueResult")
    @@index([enrollmentId])
    @@map("results")
}

model File {
    id        String    @id @default(uuid())
    createdAt DateTime  @default(now())
    deletedAt DateTime?

    filename    String
    description String?
    buffer      Bytes
    mimetype    String
    isProcessed Boolean      @default(false)
    category    FileCategory
    metadata    Json?

    userId String
    user   User   @relation(fields: [userId], references: [id])

    @@map("files")
}

model AuditLog {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())

    actorInfo String
    action    String
    entity    String
    entityId  String
    details   Json?

    @@index([entity, entityId])
    @@index([action])
    @@index([createdAt])
    @@map("audit_logs")
}

// Approval pipeline for results
model ApprovalFlow {
    id String @id @default(uuid())
    courseSession CourseSession @relation("approval_flow", fields: [courseSessionId], references: [id])
    courseSessionId String

    approvalRequests ApprovalRequest[] @relation("requested_approval")

    approvalStatus ApprovalStatus @default(REQUESTED)
    courseRequestVersion Int // Just to track how many times approval's broken
}

model ApprovalRequest {
    id String @id @default(uuid())
    status ApprovalStatus @default(REQUESTED)
    // priority in inc order of stages
    // so level 1(min) is attended to first and the progresses
    priority Int @default(1)
    
    approvalFlow ApprovalFlow @relation("requested_approval", fields: [approvalFlowId], references: [id])
    approvalFlowId String
    lecturerDesignation LecturerDesignation @relation("approval_lecturer_designation", fields: [lecturerDesignationId], references: [id])
    lecturerDesignationId String

    feedback String? // to limit feedback structure for now
}
